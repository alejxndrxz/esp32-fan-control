<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control Ventilador ESP32 - IoT</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<style>
/* (El CSS se mantiene igual al c√≥digo original) */
body { background:#111; color:#eee; font-family:Arial; text-align:center; }
.main-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; }
.card, .chart-area { background:#1c1f24; padding:20px; border-radius:12px; margin:10px; }
.chart-area { min-width: 400px; max-width: 450px; }
.card { min-width: 300px; }
.switch { width:60px; height:34px; position:relative; display:inline-block; }
.switch input { display:none; }
.slider { background:#555; position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; transition:.4s; border-radius:34px; }
.slider:before { content:""; position:absolute; height:26px; width:26px; left:4px; bottom:4px; background:white; border-radius:50%; transition:.4s; }
input:checked + .slider { background:#00c896; }
input:checked + .slider:before { transform:translateX(26px); }
</style>
</head>
<body>

<h1>ESP32 FAN CONTROL (FIREBASE IoT)</h1>

<div class="main-container">

    <div class="chart-area">
        <h2>Consumo Acumulado (Wh)</h2>
        <canvas id="energyChart" width="400" height="300"></canvas>
    </div>

    <div class="chart-area">
        <h2>Consumo por Intervalo (Wh)</h2>
        <canvas id="energyDeltaChart" width="400" height="300"></canvas>
    </div>

    <div class="card">
        <div>üå° Temp: <span id="temp">--</span> ¬∞C</div>
        <div>üíß Humedad: <span id="hum">--</span> %</div>
        <div>‚ö° Energ√≠a total: <span id="energy">--</span> Wh</div>

        <h3 id="estado">Ventilador apagado</h3>
        <p id="modo-actual">MODO: AUTOM√ÅTICO</p>

        <label class="switch">
        <input type="checkbox" id="toggleSwitch">
        <span class="slider"></span>
        </label>

        <br><br>
        <button onclick="autoMode()">Modo Autom√°tico</button>
        <br><br>
        <button onclick="verLog()">Ver Registro (Solo en ESP32 Serial)</button>
    </div>

</div>

<script>
// --- CONFIGURACI√ìN FIREBASE (REEMPLAZA CON TUS CREDENCIALES P√öBLICAS) ---
const firebaseConfig = {
    apiKey: "TU_API_KEY_WEB_PUBLICA", 
    authDomain: "esp32-fan-control-60615.firebaseapp.com",
    databaseURL: "https://esp32-fan-control-60615-default-rtdb.firebaseio.com",
    projectId: "esp32-fan-control-60615",
    // Agrega el resto de los par√°metros que te dio Firebase
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const FAN_WATTS = 5.0; // Debe coincidir con el valor del ESP32

let energyChart;
let energyDeltaChart;
const CHART_SIZE = 10;
const CHART_LABELS = [...Array(CHART_SIZE).keys()].map(n => `L${n + 1}`);

let chartData = Array(CHART_SIZE).fill(0.0);       // Energ√≠a acumulada
let chartDataDelta = Array(CHART_SIZE).fill(0.0);  // Energ√≠a por intervalo
let lastEnergy = 0.0;                              // Para calcular el incremento

// --------------------------- FUNCIONES DE GR√ÅFICOS ---------------------------

function initChart() {
    // Configuraci√≥n y creaci√≥n de energyChart (Acumulado)
    const ctx1 = document.getElementById("energyChart").getContext("2d");
    energyChart = new Chart(ctx1, {
        type: "line",
        data: {
            labels: CHART_LABELS,
            datasets: [{
                label: "Consumo acumulado (Wh)",
                data: chartData,
                borderColor: "#00c896",
                backgroundColor: "rgba(0, 200, 150, 0.2)",
                tension: 0.4
            }]
        },
        options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Wh', color: '#eee' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#eee' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#eee' } } },
            plugins: { legend: { labels: { color: '#eee' } } }
        }
    });

    // Configuraci√≥n y creaci√≥n de energyDeltaChart (Por Intervalo)
    const ctx2 = document.getElementById("energyDeltaChart").getContext("2d");
    energyDeltaChart = new Chart(ctx2, {
        type: "bar",
        data: {
            labels: CHART_LABELS,
            datasets: [{
                label: "Consumo por intervalo (Wh)",
                data: chartDataDelta,
                borderColor: "#4ade80",
                backgroundColor: "rgba(74, 222, 128, 0.3)"
            }]
        },
        options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Wh/intervalo', color: '#eee' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#eee' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#eee' } } },
            plugins: { legend: { labels: { color: '#eee' } } }
        }
    });
}

function updateCharts(energiaTotal, energiaIntervalo) {
    // Mover datos un espacio
    chartData.shift();
    chartDataDelta.shift();

    // A√±adir el nuevo valor
    chartData.push(energiaTotal);
    chartDataDelta.push(energiaIntervalo);

    energyChart.update();
    energyDeltaChart.update();
}


// --------------------------- COMUNICACI√ìN FIREBASE ---------------------------

function startFirebaseListener() {
    // Escucha la ra√≠z de la base de datos para obtener todos los datos en tiempo real
    database.ref('/').on('value', (snapshot) => {
        const data = snapshot.val();
        
        if (!data || !data.sensores || !data.estado || !data.comandos) return;

        // --- 1. DATOS DE SENSORES Y ESTADO ---
        const temp = data.sensores.temperatura || '--';
        const hum = data.sensores.humedad || '--';
        const ventState = data.estado.ventState || false;
        const controlManual = data.comandos.controlManual || false;
        const totalTimeOn_ms = data.energia.tiempoEncendido_ms || 0;
        
        document.getElementById("temp").innerText  = temp.toFixed(1);
        document.getElementById("hum").innerText   = hum.toFixed(1);
        
        // Actualizar el estado del ventilador y el control
        document.getElementById("modo-actual").innerText = controlManual ? "MODO: MANUAL" : "MODO: AUTOM√ÅTICO";
        
        const toggle = document.getElementById("toggleSwitch");
        
        // Sincroniza el interruptor con el estado actual reportado por el ESP32
        toggle.checked = ventState; 
        document.getElementById("estado").innerText = ventState ? "Ventilador ENCENDIDO" : "Ventilador APAGADO";

        // --- 2. C√ÅLCULO DE ENERG√çA ---
        // Energ√≠a total (Wh) = (tiempo_ms / 3,600,000) * Watts
        const energiaTotal = (totalTimeOn_ms / 3600000.0) * FAN_WATTS;
        document.getElementById("energy").innerText = energiaTotal.toFixed(3);

        // --- 3. ACTUALIZACI√ìN DE GR√ÅFICOS ---
        const energiaIntervalo = energiaTotal - lastEnergy;
        // Solo actualizar si ha pasado el tiempo suficiente o si la energ√≠a ha cambiado significativamente
        if (Math.abs(energiaIntervalo) > 0.001) {
            updateCharts(energiaTotal, energiaIntervalo);
            lastEnergy = energiaTotal;
        } else if (chartData.length < CHART_SIZE) {
            // Rellenar con ceros si es el inicio
            updateCharts(energiaTotal, 0); 
        }
    });
}

// --------------------------- ENVIAR COMANDOS A FIREBASE ---------------------------

// Control Manual
document.getElementById("toggleSwitch").addEventListener("change", (e) => {
    const newState = e.target.checked;
    
    // 1. Activa el modo manual
    database.ref('comandos/controlManual').set(true)
        .then(() => {
            // 2. Env√≠a el comando de estado deseado
            return database.ref('comandos/ventState').set(newState);
        })
        .catch(error => {
            console.error("Error al enviar comando manual:", error);
            alert("Error al enviar comando manual.");
        });
});

// Modo Autom√°tico
async function autoMode() {
    await database.ref('comandos/controlManual').set(false);
}

function verLog() {
    alert("El registro de eventos (Log) se imprime √∫nicamente en el Serial Monitor del ESP32.");
}

// --------------------------- INICIALIZACI√ìN ---------------------------

window.onload = () => {
    initChart();
    startFirebaseListener();
};
</script>

</body>
</html>
