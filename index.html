<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Fan Control - Firebase</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-database-compat.js"></script>

<style>
body { background:#111; color:#eee; font-family:Arial; text-align:center; }
.main-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; }
.card, .chart-area { background:#1c1f24; padding:20px; border-radius:12px; margin:10px; }
.chart-area { min-width: 400px; max-width: 450px; }
.card { min-width: 300px; }
.switch { width:60px; height:34px; position:relative; display:inline-block; }
.switch input { display:none; }
.slider { background:#555; position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; transition:.4s; border-radius:34px; }
.slider:before { content:""; position:absolute; height:26px; width:26px; left:4px; bottom:4px; background:white; border-radius:50%; transition:.4s; }
input:checked + .slider { background:#00c896; }
input:checked + .slider:before { transform:translateX(26px); }
button { padding: 10px 20px; border:none; border-radius:8px; background:#00c896; color:#111; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<h1>ESP32 FAN CONTROL</h1>

<div class="main-container">

    <div class="chart-area">
        <h2>Consumo Acumulado (Wh)</h2>
        <canvas id="energyChart" width="400" height="300"></canvas>
    </div>

    <div class="chart-area">
        <h2>Consumo por Intervalo (Wh)</h2>
        <canvas id="energyDeltaChart" width="400" height="300"></canvas>
    </div>

    <div class="card">
        <div>ðŸŒ¡ Temp: <span id="temp">--</span> Â°C</div>
        <div>ðŸ’§ Humedad: <span id="hum">--</span> %</div>
        <div>âš¡ EnergÃ­a total: <span id="energy">--</span> Wh</div>

        <h3 id="estado">Ventilador apagado</h3>

        <label class="switch">
        <input type="checkbox" id="toggleSwitch">
        <span class="slider"></span>
        </label>
    </div>

</div>

<script>
// Configurar Firebase
const firebaseConfig = {
    apiKey: "CIuEHoOaN7J1E84pGlkimA8KOxGrJH6RD430Zpic",
    databaseURL: "https://esp32-sisp-default-rtdb.firebaseio.com/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Charts
let energyChart, energyDeltaChart;
const CHART_LABELS = [...Array(10).keys()].map(n => "L" + (n+1));

function initChart() {
    const ctx1 = document.getElementById("energyChart").getContext("2d");
    energyChart = new Chart(ctx1, {
        type: "line",
        data: {
            labels: CHART_LABELS,
            datasets: [{
                label: "Consumo acumulado (Wh)",
                data: Array(10).fill(0),
                borderColor: "#00c896",
                backgroundColor: "rgba(0, 200, 150, 0.2)",
                tension: 0.4
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Wh', color: '#eee' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color:'#eee' } },
                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color:'#eee' } }
            },
            plugins: { legend: { labels: { color: '#eee' } } }
        }
    });

    const ctx2 = document.getElementById("energyDeltaChart").getContext("2d");
    energyDeltaChart = new Chart(ctx2, {
        type: "bar",
        data: {
            labels: CHART_LABELS,
            datasets: [{
                label: "Consumo por intervalo (Wh)",
                data: Array(10).fill(0),
                borderColor: "#4ade80",
                backgroundColor: "rgba(74, 222, 128, 0.3)"
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Wh/intervalo', color:'#eee' }, grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#eee' } },
                x: { grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#eee' } }
            },
            plugins: { legend: { labels: { color:'#eee' } } }
        }
    });
}

// Leer datos de Firebase
function fetchData() {
    db.ref("/temperature").once("value").then(snapshot => {
        document.getElementById("temp").innerText = snapshot.val() || "--";
    });
    db.ref("/humidity").once("value").then(snapshot => {
        document.getElementById("hum").innerText = snapshot.val() || "--";
    });
    db.ref("/energy").once("value").then(snapshot => {
        document.getElementById("energy").innerText = snapshot.val() || "--";
    });
    db.ref("/ventState").once("value").then(snapshot => {
        const state = snapshot.val();
        const toggle = document.getElementById("toggleSwitch");
        document.getElementById("estado").innerText = state ? "Ventilador ENCENDIDO" : "Ventilador APAGADO";
        toggle.checked = state;
    });
    // Graficas
    db.ref("/chartData").once("value").then(snapshot => {
        energyChart.data.datasets[0].data = snapshot.val() || Array(10).fill(0);
        energyChart.update();
    });
    db.ref("/chartDelta").once("value").then(snapshot => {
        energyDeltaChart.data.datasets[0].data = snapshot.val() || Array(10).fill(0);
        energyDeltaChart.update();
    });
}

window.onload = () => {
    initChart();
    fetchData();
    setInterval(fetchData, 2000);
};
</script>
</body>
</html>
