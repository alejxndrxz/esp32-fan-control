<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control Ventilador ESP32</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial;
    background: #111;
    color: #fff;
    margin: 0;
    padding: 20px;
}
.card {
    background: #222;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}
button {
    padding: 12px 20px;
    background: #0a84ff;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    cursor: pointer;
}
.status {
    font-size: 22px;
    margin-top: 10px;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>Panel de Control</h2>

<div class="card">
    <p>ðŸŒ¡ Temperatura: <span id="temp">--</span> Â°C</p>
    <p>ðŸ’§ Humedad: <span id="hum">--</span> %</p>

    <button id="btnVent">Cargarâ€¦</button>
    <p class="status">Estado: <span id="ventState">--</span></p>
</div>

<h2>GrÃ¡fica en Tiempo Real</h2>
<div class="card">
    <canvas id="chart" height="120"></canvas>
</div>

<script>
// ------------------------- CONFIG FIREBASE -------------------------
const firebaseConfig = {
    apiKey: "TU_API",
    authDomain: "esp32-sisp.firebaseapp.com",
    databaseURL: "https://esp32-sisp-default-rtdb.firebaseio.com",
    projectId: "esp32-sisp",
    storageBucket: "esp32-sisp.appspot.com",
    messagingSenderId: "000000000",
    appId: "1:000000:web:000000"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();

// ------------------------- UI DE ESTADO -------------------------
const tempUI = document.getElementById("temp");
const humUI = document.getElementById("hum");
const ventUI = document.getElementById("ventState");
const btnVent = document.getElementById("btnVent");

// ------------------------- LEER DATOS latest -------------------------
db.ref("latest").on("value", snap => {
    const d = snap.val();
    if (!d) return;

    tempUI.textContent = d.temperature;
    humUI.textContent = d.humidity;
    ventUI.textContent = d.ventState ? "Encendido" : "Apagado";

    btnVent.textContent = d.ventState ? "Apagar Ventilador" : "Encender Ventilador";
});

// ------------------------- CAMBIAR ESTADO -------------------------
btnVent.onclick = () => {
    db.ref("latest/ventState").once("value").then(snap => {
        const newState = !snap.val();
        db.ref("latest/ventState").set(newState);
    });
};

// ------------------------- GRÃFICA -------------------------
let ctx = document.getElementById("chart").getContext("2d");

let chart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "Temperatura",
            data: [],
            borderWidth: 2
        }]
    },
    options: {
        scales: {
            y: { beginAtZero: false }
        }
    }
});

// Escuchar chartData
db.ref("chartData").on("value", snap => {
    const d = snap.val();
    if (!d) return;

    chart.data.labels = d.map((_, i) => i);
    chart.data.datasets[0].data = d;
    chart.update();
});
</script>
</body>
</html>
